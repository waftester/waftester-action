name: Test Action
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write   # For SARIF upload test

jobs:
  # ── F47: Core install test across 3 OSes ──────────────
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          upload-sarif: false
      - name: Verify outputs
        shell: bash
        env:
          EXIT_CODE: ${{ steps.waf.outputs.exit-code }}
          VERSION: ${{ steps.waf.outputs.version }}
        run: |
          echo "exit-code=${EXIT_CODE}"
          echo "version=${VERSION}"
          [[ -n "${VERSION}" ]] || { echo "::error::version output empty"; exit 1; }

  # ── F47: SARIF generation + validation ──────────────────
  # Validates real vulnerability scanning with SARIF output format.
  # Uses CORS scan type (~10 requests, completes in <5s) for a fast but
  # genuine security scan. This tests the full pipeline: binary install →
  # payload scan → SARIF output → outputs set.
  test-sarif:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: scan
          format: sarif
          args: '-types cors'
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Validate outputs
        env:
          EXIT_CODE: ${{ steps.waf.outputs.exit-code }}
          VERSION: ${{ steps.waf.outputs.version }}
          BYPASS_COUNT: ${{ steps.waf.outputs.bypass-count }}
          SUMMARY: ${{ steps.waf.outputs.summary }}
        run: |
          echo "exit-code=${EXIT_CODE}"
          echo "version=${VERSION}"
          echo "bypass-count=${BYPASS_COUNT}"
          echo "summary=${SUMMARY}"

          # Verify key outputs are set
          [[ -n "${EXIT_CODE}" ]] || { echo "::error::exit-code output not set"; exit 1; }
          [[ -n "${VERSION}" ]]   || { echo "::error::version output not set"; exit 1; }
          [[ -n "${SUMMARY}" ]]   || { echo "::error::summary output not set"; exit 1; }

          # Verify output file was generated and valid
          if [[ -f "waftester-results.sarif" ]]; then
            SIZE=$(wc -c < waftester-results.sarif)
            echo "File size: ${SIZE} bytes"
            if [[ ${SIZE} -lt 50 ]]; then
              echo "::error::SARIF file is suspiciously small (${SIZE} bytes)"
              exit 1
            fi
            # Validate it's parseable JSON
            jq empty waftester-results.sarif || { echo "::error::SARIF file is not valid JSON"; exit 1; }
            echo "✅ SARIF output file generated and valid"
          else
            echo "::error::No SARIF file generated"
            exit 1
          fi

          echo "✅ All outputs validated"

  # ── F47: Pinned version resolves correctly ─────────────
  test-version-pin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          version: '2.8.2'
          upload-sarif: false
      - name: Verify pinned version
        env:
          INSTALLED: ${{ steps.waf.outputs.version }}
        run: |
          [[ "${INSTALLED}" == "2.8.2" ]] || {
            echo "::error::Expected 2.8.2 but got ${INSTALLED}"
            exit 1
          }

  # ── F47: Exit code behavior + fail-on-bypass ──────────
  test-exit-codes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      # Test 1: fail-on-bypass=false should pass even with bypasses
      - uses: ./
        id: pass
        with:
          target: https://httpbin.org
          scan-type: vendor
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Verify pass mode
        env:
          EXIT_CODE: ${{ steps.pass.outputs.exit-code }}
        run: |
          echo "Exit code: ${EXIT_CODE}"
          # Step should have passed regardless of exit code

  # ── F47: Invalid inputs produce clear errors ───────────
  test-invalid-inputs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      # Invalid version should fail install
      - uses: ./
        id: bad-version
        continue-on-error: true
        with:
          target: https://httpbin.org
          version: 'not-a-version'
          upload-sarif: false
      - name: Verify failure
        env:
          OUTCOME: ${{ steps.bad-version.outcome }}
        run: |
          [[ "${OUTCOME}" == "failure" ]] || {
            echo "::error::Expected failure for invalid version"
            exit 1
          }

  # ── F47: Custom scan-type passthrough ──────────────────
  test-custom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: custom
          args: 'vendor -u https://httpbin.org'
          upload-sarif: false
      - name: Verify custom ran
        env:
          EXIT_CODE: ${{ steps.waf.outputs.exit-code }}
        run: |
          echo "Exit code: ${EXIT_CODE}"
          echo "Custom scan-type passthrough verified"
