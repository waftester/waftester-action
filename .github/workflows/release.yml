name: Release — Float Major Tag
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  float-major-tag:
    # F56: Skip pre-release tags — don't float v1 to unstable
    if: ${{ !github.event.release.prerelease }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Extract major version
        id: version
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          MAJOR="${TAG%%.*}"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "::notice::Floating ${MAJOR} → ${TAG}"

      - name: Update floating tag
        env:
          MAJOR: ${{ steps.version.outputs.major }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa "${MAJOR}" -m "${MAJOR} → ${TAG}"
          git push origin "${MAJOR}" --force

  # ── F45: Smoke test before declaring success ───────────
  smoke-test:
    needs: float-major-tag
    runs-on: ubuntu-latest
    steps:
      - name: Test floating tag resolves
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          MAJOR="${RELEASE_TAG}"
          MAJOR="${MAJOR%%.*}"
          # Verify the floating tag exists on the remote
          git ls-remote --tags \
            "https://github.com/${REPO_FULL_NAME}" \
            "refs/tags/${MAJOR}" | grep -q "${MAJOR}" || {
              echo "::error::Floating tag ${MAJOR} not found on remote"
              exit 1
            }
          echo "✅ Floating tag ${MAJOR} verified"
