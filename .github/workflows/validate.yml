name: Validate
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # ── actionlint — validates action.yml + all workflow YAML ──
  actionlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: actionlint
        run: |
          # Pin installer to specific commit — never curl|bash from floating main
          bash <(curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/62dc61a45fc95eed8c2b441f0b044a1f6e3ac8b5/scripts/download-actionlint.bash)
          ./actionlint -color

  # ── action-yml-schema — validates action.yml against official schema ──
  action-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate action.yml schema
        uses: cardinalby/schema-validator-action@77eb17b070f282db4680215551cae4d9c379f2f4 # v3
        with:
          file: action.yml
          schema: 'https://json.schemastore.org/github-action.json'

  # ── ShellCheck — lint all bash scripts ──
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: ShellCheck install.sh
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # 2.0.0
        with:
          scandir: '.'
          severity: warning

  # ── Markdown lint — validate all documentation ──
  markdownlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: markdownlint
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: '**/*.md'

  # ── YAML structure — validate all YAML files parse correctly ──
  yaml-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate YAML files
        run: |
          set -euo pipefail
          errors=0
          # Use process substitution (not pipe) so error counter stays in current shell
          while IFS= read -r -d '' f; do
            if ! python3 -c "import yaml, sys; yaml.safe_load(open(sys.argv[1]))" "$f"; then
              echo "::error file=$f::Invalid YAML syntax"
              errors=$((errors + 1))
            fi
          done < <(find . \( -name '*.yml' -o -name '*.yaml' \) -not -path '*/node_modules/*' -print0)
          if [[ $errors -gt 0 ]]; then
            echo "::error::$errors YAML file(s) have syntax errors"
            exit 1
          fi
          echo "✅ All YAML files valid"

  # ── Script syntax — bash -n parse check ──
  bash-syntax:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Check bash syntax
        run: |
          set -euo pipefail
          for f in install.sh entrypoint.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done
          echo "✅ All scripts parse correctly"

  # ── Composite action dry-run — verify steps can be resolved ──
  action-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Verify action.yml structure
        run: |
          set -euo pipefail
          # Check required top-level keys
          for key in name description inputs outputs runs; do
            if ! grep -q "^${key}:" action.yml; then
              echo "::error::Missing required key: ${key}"
              exit 1
            fi
          done
          # Check runs.using is 'composite'
          if ! grep -q "using: 'composite'" action.yml && \
             ! grep -q 'using: "composite"' action.yml && \
             ! grep -q "using: composite" action.yml; then
            echo "::error::action.yml must use 'composite' runs type"
            exit 1
          fi
          # Check all referenced scripts exist
          for script in install.sh entrypoint.sh; do
            if [[ ! -f "$script" ]]; then
              echo "::error::Referenced script not found: $script"
              exit 1
            fi
            if [[ ! -x "$script" ]]; then
              echo "::warning file=$script::Script is not executable (chmod +x needed)"
            fi
          done
          echo "✅ action.yml structure valid"

  # ── Example workflows — validate all example YAML files ──
  validate-examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate example workflows
        run: |
          set -euo pipefail
          count=0
          for f in examples/*.yml; do
            if [[ ! -f "$f" ]]; then
              echo "::error::No example workflows found in examples/"
              exit 1
            fi
            python3 -c "import yaml, sys; yaml.safe_load(open(sys.argv[1]))" "$f"
            count=$((count + 1))
          done
          echo "✅ $count example workflow(s) valid"

  # ── Link check — verify README links aren't broken ──
  link-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@499c1e7f3637c131334fa8e937c45144f79d72d2 # v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true  # Don't fail on external link issues
