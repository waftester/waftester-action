name: Test Action
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write   # For SARIF upload test

jobs:
  # ── F47: Core install test across 3 OSes ──────────────
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          upload-sarif: false
      - name: Verify outputs
        shell: bash
        run: |
          echo "exit-code=${{ steps.waf.outputs.exit-code }}"
          echo "version=${{ steps.waf.outputs.version }}"
          [[ -n "${{ steps.waf.outputs.version }}" ]] || { echo "::error::version output empty"; exit 1; }

  # ── F47: SARIF generation + validation ──────────────────
  test-sarif:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: scan
          format: sarif
          args: '-types sqli --smart'
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Validate SARIF output
        run: |
          FILE="${{ steps.waf.outputs.sarif-file }}"
          if [[ -z "$FILE" ]]; then
            echo "::warning::sarif-file output not set — scan may not have produced output"
            # Still check if default file exists
            FILE="waftester-results.sarif"
          fi
          if [[ -f "$FILE" ]]; then
            jq empty "$FILE" || { echo "::error::SARIF is not valid JSON"; exit 1; }
            echo "File size: $(wc -c < "$FILE") bytes"
            echo "First 200 chars: $(head -c 200 "$FILE")"
            echo "✅ SARIF file exists and is valid JSON"
          else
            echo "::warning::SARIF file not found at $FILE — this may be expected if the scan produced no results"
          fi
          echo "Exit code from scan: ${{ steps.waf.outputs.exit-code }}"

  # ── F47: Pinned version resolves correctly ─────────────
  test-version-pin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          version: '2.8.1'
          upload-sarif: false
      - name: Verify pinned version
        run: |
          INSTALLED="${{ steps.waf.outputs.version }}"
          [[ "$INSTALLED" == "2.8.1" ]] || {
            echo "::error::Expected 2.8.1 but got $INSTALLED"
            exit 1
          }

  # ── F47: Exit code behavior + fail-on-bypass ──────────
  test-exit-codes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Test 1: fail-on-bypass=false should pass even with bypasses
      - uses: ./
        id: pass
        with:
          target: https://httpbin.org
          scan-type: vendor
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Verify pass mode
        run: |
          echo "Exit code: ${{ steps.pass.outputs.exit-code }}"
          # Step should have passed regardless of exit code

  # ── F47: Invalid inputs produce clear errors ───────────
  test-invalid-inputs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Invalid version should fail install
      - uses: ./
        id: bad-version
        continue-on-error: true
        with:
          target: https://httpbin.org
          version: 'not-a-version'
          upload-sarif: false
      - name: Verify failure
        run: |
          [[ "${{ steps.bad-version.outcome }}" == "failure" ]] || {
            echo "::error::Expected failure for invalid version"
            exit 1
          }

  # ── F47: Custom scan-type passthrough ──────────────────
  test-custom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: custom
          args: 'vendor -u https://httpbin.org'
          upload-sarif: false
      - name: Verify custom ran
        run: |
          echo "Exit code: ${{ steps.waf.outputs.exit-code }}"
          echo "Custom scan-type passthrough verified"
