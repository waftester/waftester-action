name: Test Action
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write   # For SARIF upload test

jobs:
  # ── F47: Core install test across 3 OSes ──────────────
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          upload-sarif: false
      - name: Verify outputs
        shell: bash
        run: |
          echo "exit-code=${{ steps.waf.outputs.exit-code }}"
          echo "version=${{ steps.waf.outputs.version }}"
          [[ -n "${{ steps.waf.outputs.version }}" ]] || { echo "::error::version output empty"; exit 1; }

  # ── F47: SARIF generation + validation ──────────────────
  # Validates real vulnerability scanning with SARIF output format.
  # Uses CORS scan type (~10 requests, completes in <5s) for a fast but
  # genuine security scan. This tests the full pipeline: binary install →
  # payload scan → SARIF output → outputs set.
  test-sarif:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: scan
          format: sarif
          args: '-types cors'
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Validate outputs
        run: |
          echo "exit-code=${{ steps.waf.outputs.exit-code }}"
          echo "version=${{ steps.waf.outputs.version }}"
          echo "bypass-count=${{ steps.waf.outputs.bypass-count }}"
          echo "summary=${{ steps.waf.outputs.summary }}"

          # Verify key outputs are set
          [[ -n "${{ steps.waf.outputs.exit-code }}" ]] || { echo "::error::exit-code output not set"; exit 1; }
          [[ -n "${{ steps.waf.outputs.version }}" ]]   || { echo "::error::version output not set"; exit 1; }
          [[ -n "${{ steps.waf.outputs.summary }}" ]]   || { echo "::error::summary output not set"; exit 1; }

          # Verify output file was generated
          if [[ -f "waftester-results.sarif" ]]; then
            echo "✅ SARIF output file generated"
            echo "File size: $(wc -c < waftester-results.sarif) bytes"
          else
            echo "⚠️ No SARIF file (expected for scan output)"
          fi

          echo "✅ All outputs validated"

  # ── F47: Pinned version resolves correctly ─────────────
  test-version-pin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: vendor
          version: '2.8.2'
          upload-sarif: false
      - name: Verify pinned version
        run: |
          INSTALLED="${{ steps.waf.outputs.version }}"
          [[ "$INSTALLED" == "2.8.2" ]] || {
            echo "::error::Expected 2.8.2 but got $INSTALLED"
            exit 1
          }

  # ── F47: Exit code behavior + fail-on-bypass ──────────
  test-exit-codes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      # Test 1: fail-on-bypass=false should pass even with bypasses
      - uses: ./
        id: pass
        with:
          target: https://httpbin.org
          scan-type: vendor
          fail-on-bypass: false
          fail-on-error: false
          upload-sarif: false
      - name: Verify pass mode
        run: |
          echo "Exit code: ${{ steps.pass.outputs.exit-code }}"
          # Step should have passed regardless of exit code

  # ── F47: Invalid inputs produce clear errors ───────────
  test-invalid-inputs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      # Invalid version should fail install
      - uses: ./
        id: bad-version
        continue-on-error: true
        with:
          target: https://httpbin.org
          version: 'not-a-version'
          upload-sarif: false
      - name: Verify failure
        run: |
          [[ "${{ steps.bad-version.outcome }}" == "failure" ]] || {
            echo "::error::Expected failure for invalid version"
            exit 1
          }

  # ── F47: Custom scan-type passthrough ──────────────────
  test-custom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: waf
        with:
          target: https://httpbin.org
          scan-type: custom
          args: 'vendor -u https://httpbin.org'
          upload-sarif: false
      - name: Verify custom ran
        run: |
          echo "Exit code: ${{ steps.waf.outputs.exit-code }}"
          echo "Custom scan-type passthrough verified"
