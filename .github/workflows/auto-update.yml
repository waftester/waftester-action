name: Auto-Update CLI Version

# Triggered by CLI repo's release workflow via repository_dispatch
on:
  repository_dispatch:
    types: [cli-release]

permissions:
  contents: write

# Serialize â€” never run two auto-updates in parallel
concurrency:
  group: auto-update
  cancel-in-progress: false

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      CLI_VERSION: ${{ github.event.client_payload.version }}
      CLI_TAG: ${{ github.event.client_payload.tag }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Validate payload
        run: |
          if [[ -z "$CLI_VERSION" ]]; then
            echo "::error::Missing version in dispatch payload"
            exit 1
          fi
          # Strict semver validation â€” reject anything that isn't X.Y.Z
          if [[ ! "$CLI_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: '$CLI_VERSION'. Expected: X.Y.Z (e.g., 2.8.2)"
            exit 1
          fi
          if [[ -z "$CLI_TAG" ]]; then
            CLI_TAG="v${CLI_VERSION}"
            echo "CLI_TAG=${CLI_TAG}" >> "$GITHUB_ENV"
            echo "::notice::CLI_TAG not provided, defaulting to ${CLI_TAG}"
          fi
          echo "ðŸ“¦ CLI version: ${CLI_VERSION} (tag: ${CLI_TAG})"

      - name: Determine next action version
        id: next-version
        run: |
          # Get the latest release tag (e.g., v1.0.1)
          LATEST=$(gh release view --json tagName -q '.tagName' 2>/dev/null || echo "v1.0.0")
          echo "Latest action release: ${LATEST}"
          
          # Validate tag is strict semver before parsing
          if [[ ! "$LATEST" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Latest release tag '${LATEST}' is not semver (vX.Y.Z). Cannot auto-increment."
            exit 1
          fi

          # Bump patch version
          MAJOR=$(echo "$LATEST" | sed -E 's/v([0-9]+)\..*/\1/')
          MINOR=$(echo "$LATEST" | sed -E 's/v[0-9]+\.([0-9]+)\..*/\1/')
          PATCH=$(echo "$LATEST" | sed -E 's/v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
          NEXT_PATCH=$((PATCH + 1))
          NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
          
          echo "next_tag=${NEXT_TAG}" >> "$GITHUB_OUTPUT"
          echo "major=v${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Œ Next action tag: ${NEXT_TAG}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version references in README
        env:
          NEXT_ACTION: ${{ steps.next-version.outputs.next_tag }}
        run: |
          # 1. CLI version badge (marked with <!-- x-cli-version -->)
          sed -i -E "s|CLI-v[0-9]+\.[0-9]+\.[0-9]+-|CLI-v${CLI_VERSION}-|g" README.md
          sed -i -E "s|releases/tag/v[0-9]+\.[0-9]+\.[0-9]+\)(.* x-cli-version)|releases/tag/v${CLI_VERSION})\1|g" README.md
          
          # 2. CLI version in pinning example (version: 'x.y.z')
          sed -i -E "s|(version: ')[0-9]+\.[0-9]+\.[0-9]+(')|\1${CLI_VERSION}\2|g" README.md
          
          # 3. CLI version in outputs table
          sed -i -E "s|(Installed WAFtester version \| \`)[0-9]+\.[0-9]+\.[0-9]+(\`)|\1${CLI_VERSION}\2|g" README.md
          
          # 4. Action version in pinning example (uses: ...@vX.Y.Z and git rev-parse)
          sed -i -E "s|(waftester-action@v)[0-9]+\.[0-9]+\.[0-9]+|\1${NEXT_ACTION#v}|g" README.md
          sed -i -E "s|(git rev-parse v)[0-9]+\.[0-9]+\.[0-9]+|\1${NEXT_ACTION#v}|g" README.md
          
          # Show what changed
          if git diff --quiet README.md; then
            echo "â„¹ï¸ No version references to update in README"
          else
            echo "ðŸ“ Updated version references:"
            git diff README.md
          fi

      - name: Update CHANGELOG
        env:
          NEXT_ACTION: ${{ steps.next-version.outputs.next_tag }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          ENTRY="## [${NEXT_ACTION}] - ${DATE}\n\n### Changed\n\n- Bump bundled CLI to WAFtester v${CLI_VERSION}\n"
          # Insert before the first ## header; if none exists, append to file
          if grep -q '^## ' CHANGELOG.md; then
            sed -i "0,/^## /{s|^## |${ENTRY}\n## |}" CHANGELOG.md
          else
            echo -e "${ENTRY}" >> CHANGELOG.md
          fi
          echo "ðŸ“ Added CHANGELOG entry for ${NEXT_ACTION}"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet; then
            git add README.md CHANGELOG.md
            git commit -m "chore(deps): bump CLI version to ${CLI_VERSION}"
            git push
            echo "âœ… Version bump committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Create action release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_TAG: ${{ steps.next-version.outputs.next_tag }}
        run: |
          NOTES="## WAFtester Action ${NEXT_TAG}

          Updates bundled CLI to **WAFtester ${CLI_VERSION}**.

          See [CLI changelog](https://github.com/waftester/waftester/releases/tag/${CLI_TAG}) for details.

          ### Usage

          \`\`\`yaml
          - uses: waftester/waftester-action@v1
            with:
              target: https://app.example.com
          \`\`\`"

          # YAML run: | block scalar already strips leading indentation,
          # so NOTES content has no extra whitespace to remove.
          printf '%s\n' "$NOTES" > /tmp/release_notes.md

          gh release create "${NEXT_TAG}" \
            --title "WAFtester Action ${NEXT_TAG}" \
            --notes-file /tmp/release_notes.md \
            --latest

          echo "âœ… Created release ${NEXT_TAG}"

      # Float the major version tag (e.g., v1 â†’ v1.0.6) so users on @v1 get updates.
      # This MUST be done here, not delegated to release.yml, because releases
      # created with GITHUB_TOKEN do not trigger other workflows (GitHub's
      # anti-recursion rule). See: https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow
      - name: Float major version tag
        env:
          NEXT_TAG: ${{ steps.next-version.outputs.next_tag }}
          MAJOR: ${{ steps.next-version.outputs.major }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa "${MAJOR}" -m "${MAJOR} â†’ ${NEXT_TAG}"
          git push origin "${MAJOR}" --force
          echo "âœ… Floated ${MAJOR} â†’ ${NEXT_TAG}"
